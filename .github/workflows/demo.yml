name: DR-PACT AI Demo

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allows you to run this manually from the Actions tab

jobs:
  ai-contract-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow workflow to commit and push changes

    steps:
    # 1. Checkout the code
    - uses: actions/checkout@v4

    # 2. Setup Python (for Agent & Provider)
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3. Setup Node.js (for Consumer)
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # 4. Install All Dependencies
    - name: Install Dependencies
      run: |
        # Install AI Agent deps
        pip install -r agent/requirements.txt
        # Install Provider deps
        pip install -r provider-py/requirements.txt
        # Install Consumer deps
        cd consumer-ts && npm install

    # 5. ğŸ¤– Run the AI Agent
    # This reads both codes and generates the contract file
    - name: ğŸ¤– AI Agent - Generate Contracts
      env:
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      run: python agent/generator.py --provider groq

    # 6. ğŸ§ª Run Consumer Tests
    # This runs the generated Pact test to create the JSON contract
    - name: ğŸ§ª Run Consumer Tests (Generate Pact JSON)
      run: cd consumer-ts && npm test

    # 7. ğŸ’¾ Commit Generated Files
    # This commits the AI-generated contract files back to the repo
    - name: ğŸ’¾ Commit Generated Contract Files
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add consumer-ts/tests/contract.spec.ts pacts/*.json
        # Only commit if there are changes
        git diff --staged --quiet || git commit -m "ğŸ¤– Auto-generate contract files [skip ci]"
    
    # 8. ğŸ“¤ Push Changes
    - name: ğŸ“¤ Push Generated Files
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}

    # 9. âœ… Verify Provider
    # We start the Flask app in the background using '&'
    # Then we wait a few seconds for it to boot up
    # Then we run the tests against 'localhost'
    - name: âœ… Verify Provider API
      run: |
        echo "ğŸš€ Starting Provider API in background..."
        
        # Start the app and send logs to a file so we don't clutter the output
        # Use 'python -m provider-py.app' or just 'python provider-py/app.py' depending on your structure
        # ensuring PYTHONPATH includes the current directory
        export PYTHONPATH=$PYTHONPATH:$(pwd)/provider-py
        nohup python provider-py/app.py > provider.log 2>&1 &
        
        # Wait 5 seconds to ensure Flask is ready
        echo "â³ Waiting for server to boot..."
        sleep 5
        
        # Print the logs just to be safe (helps debugging)
        echo "ğŸ“„ Server Logs:"
        cat provider.log
        
        # Now run the verification tests
        echo "ğŸ§ª Running Pytest..."
        cd provider-py && pytest tests/test_pact.py -v